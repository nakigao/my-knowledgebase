:: howto_deploy_from_ova(WindowsOS).md
===

VMWare(仮想環境)における、新規VMサーバーのセットアップ手順に関するマニュアル

## 1. キッティング用サーバーパラメータの選定

キッティング用サーバーパラメータ(サンプル)

```
ID              :ID_XXXXXXXXXX
VM-HOSTNAME     :VM_XXXXXXXXXX
GUEST-HOSTNAME  :GUEST_XXXXXXXXXX
CPU             :1Core2CPU
MEMORY          :2048MB
HDD             :32GB
NETWORK-IP      :XXX.XXX.XXX.XXX
NETWORK-SUBNET  :255.255.255.0
NETWORK-GATEWAY :XXX.XXX.XXX.1
```

## 2. Winodowsのリソースの初期化

### 2-1. 固有情報の初期化(Sysprep.exe)

パワーシェルにて初期化ユーティリティ実行

```
`C:\Windows\System32\sysprep\sysprep.exe`
```

システム準備ツールが起動するので以下の設定を行い、OKボタンを押下

```
システムクリーンアップアクション        システムの OOBE(Out-of-Box Experience)に入る
一般化する                              チェックON
シャットダウンオプション                終了
```

sysprepの完了を待ち、ダイアログが消えたらシャットダウン

### 2-2. ディスクの初期化

```
サーバマネジャ > 記憶域 > ディスクの管理 > ディスクの初期化
※表示が出ない場合は、初期化完了しているので何もしない
```

再起動

Windowsの初回起動時セットアップの完了を待つ

## 3. 新規GUEST-OSのセットアップ

ローカル管理ユーザーでログイン

### 3-1. HOST名称の変更とネットワークアダプタの初期化

PC名の変更

```
コンピュータ > プロパティ > システム詳細設定 > コンピュータ名 > 変更
    コンピュータ名 ※キッティング情報の名前
    ※このときグループは変更しない
```

ネットワークアダプタの名称変更

```
ネットワークと共有設定 > 該当のアダプタ(右クリック) > 名前の変更
※表のセグメント = PRIMARY_LAN
※裏のセグメント = SECONDARY_LAN
```

表のセグメントのIPアドレス情報の更新

```
ネットワークと共有設定 > 該当のアダプタ(右クリック) > プロパティ > ネットワークタブ

TCP/IPv6 無効化
TCP/IPv4 有効化 > プロパティ
    次のIPアドレスを使う
        IPアドレス                 ※キッティング情報より設定
        サブネットマスク           ※キッティング情報より設定
        デフォルトゲートウェイ     ※キッティング情報より設定
    次のDNSサーバーのアドレスを使う
        優先DNSサーバー           XXX.XXX.XXX.XXX
        代替DNSサーバー           XXX.XXX.XXX.XXX
```

裏のセグメントのIPアドレス情報の更新

```
ネットワークと共有設定 > 該当のアダプタ(右クリック) > プロパティ > ネットワークタブ

TCP/IPv6 無効化
TCP/IPv4 有効化 > プロパティ
    次のIPアドレスを使う
        IPアドレス                 XXX.XXX.yyy.yyy   ※yyy部は表のセグメントと同値にする
        サブネットマスク           255.255.0.0
        デフォルトゲートウェイ     設定無し
    次のDNSサーバーのアドレスを使う
        優先DNSサーバー           設定無し
        代替DNSサーバー           設定無し
TCP/IPv4 有効化 > プロパティ > 詳細設定 > DNS
    この接続のアドレスをDNSに登録する          チェックOFF
```

GUEST-OSのシャットダウン

VMHOST-SERVERの設定タブで、GUEST-OSのネットワークアダプタを有効化する

```
ゲスト(選択) > 設定の編集 > ネットワークアダプタ > パワーオン時に接続 > チェックON
```

### 3-2. ドメイン参加

GUEST-OSの起動

ローカル管理ユーザーでログイン

ドメインに参加を実施

```
コンピュータ > プロパティ > システム詳細設定 > コンピュータ名 > 変更
    所属するグループ > ドメイン     mydomain.local
```

GUEST-OSの再起動

ドメイン管理ユーザーでログイン

```
LOGON:      mydomain
USERID:     domainuserid
PASSWD:     domainuserpass
```

正規のパラメータに変更されたことを確認

```
ipconfig /all
```

※以降は、リモートデスクトップを用いてドメインユーザーとしてログイン可能

## 4. ライセンス認証

GUEST-OSのパワーオン

ドメイン管理ユーザーでログイン

現在のサーバーライセンスを確認

```
PS C:\Users\domainuserid> slmgr -dlv
※しばらく待つとライセンス情報ダイアログが出る
※一時的なライセンス認証になっていると思う(ライセンスの状態: 最初の猶予期間)
```

サーバーライセンスで再認証する

```
※Powershellを管理者権限で実行

PS C:\Users\domainuserid> slmgr -ipk XXXX-XXXX-XXXX-XXXX(プロダクトキー)
※しばらく待つと、ダイアログが出る

PS C:\Users\domainuserid> slmgr -ato
※しばらく待つと、ダイアログが出る
```

認証状態の確認

```
PS C:\Users\domainuserid> slmgr -dlv
※「ライセンス状態: ライセンスされています」でOK
```

## 5. サーバー設定情報の確認

サーバースペックが正しいか確認する

- システムリソースの状態 ... システム > プロパティ
- ネットワークの状態 ... `ipconfig -all`
- WindowsOSの認証状態 ... `slmgr -dlv`

## 6. GUEST-OSの自動起動設定の有効化

常時稼動するサーバの場合は自動起動にする

```
VMWareホスト > 「構成」 > 「ソフトウェア」項目 > 「仮想マシン起動/シャットダウン」クリック
    「起動順序」画面 > 右上側の青文字表記の「プロパティ...」クリック > 仮想マシンの起動及びシャットダウン・メニューが開く
        『上へ』・『下へ』ボタンにて自動起動の順位を変更 ... 手動起動の場合は「手動での起動」まで下げる

※大概は、手動での起動より自動起動へ変更（優先順位順）
```